# B4.REGIME_POSTERIOR_CONCENTRATION (Stage A — Investigative Audit)

## Topology & Regime Identification Intent — B4.REGIME_POSTERIOR_CONCENTRATION
- **Regime definition:** In B4, regimes are the mixture components produced by Stage2 corrections. For `capopm`, Stage2 is enabled with `mode="offsets_mixture"` in `build_base_config` (`src/capopm/experiments/b4_regime_posterior_concentration.py:37-40,98-193`), and mixture outputs include `regime_weights`/`regime_params` (computed in `capopm_pipeline` → `stage2_structural.mixture_posterior_params` at `src/capopm/corrections/stage2_structural.py:144-199`). Regime metrics `regime_entropy` and `regime_max_weight` are derived from mixture weights via `regime_entropy`/`regime_max_weight` (`src/capopm/experiments/regime_metrics.py`, imported at `b4_regime_posterior_concentration.py:23`).
- **Regime labels in synthetic DGP:** Ground-truth regime labels are not drawn from the simulator; regimes are model components defined by Stage2 priors (mixing weights and offsets) rather than known latent classes. No explicit DGP regime label appears in summary/audit; mixture is inferred from trade data with prior regimes configured in Stage2 (regimes list in `build_base_config`: two regimes with ±0.05 offsets, `b4_regime_posterior_concentration.py:173-187`).
- **Regime posterior computation:** `capopm_pipeline` (Stage1+Stage2 enabled for capopm: `b4_regime_posterior_concentration.py:271-294`) calls Stage2 mixture; when mixture enabled, `mixture_mean` and `mixture_weights` are used; `regime_entropy`/`max_weight` computed from weights (`b4_regime_posterior_concentration.py:282-294`). Other models (capopm_stage1_only, uncorrected, raw_parimutuel) do not produce mixture weights (set to NaN). Posterior update base: Beta-Binomial counts (`likelihood.py:33-43`) and priors; Stage1 weights off for capopm here (enabled True by default config).
- **Concentration meaning (metric):** Concentration measured via Shannon entropy and maximum regime weight: `regime_entropy` and `regime_max_weight` fields in aggregated metrics (`b4_regime_posterior_concentration.py:282-294`). Audit criterion `regime_entropy_defined` expects entropy ≤ 0 (finite and defined) per `audit_contracts.py:175-188`. Grid criterion requires multiple evidence_strength points for movement. Audit uses entropy only; max_weight present in summary but not audited.
- **Sweep to test concentration:** Evidence strength grid controls prior counts/likelihood strength via `apply_evidence_strength(cfg, strength)` (implementation not shown; presumed to scale evidence or counts before Stage2). Sweep parameters recorded in `summary.json` (`results/B4_regime_concentration__evidence50__seed0/summary.json:sweep_params.evidence_strength` and evidence150 counterpart). Only one evidence_strength per scenario in audited outputs (50 vs 150 tags), so grid is incomplete for cross-scenario trend.
- **Smoke tests touching regimes:** `smoke_test_b4_regime_posterior_concentration.py:1-106` runs evidence_strength_grid=[0.5,1.5], n_runs=3; validates artifacts and schemas; asserts finite `regime_entropy` and `regime_max_weight` for capopm; checks monotone trend: entropy decreases and max_weight increases with evidence_strength (lines 64-89). Enforces determinism across reruns (lines 91-103). No paper citation; assumes concentration trend at small n.

## Smoke Test Audit
- **smoke_test_b4_regime_posterior_concentration.py**  
  - **Assumptions:** Evidence strength increase should (1) decrease regime entropy and (2) increase max weight, even at n_runs=3. Asserts finite regime metrics and deterministic outputs.  
  - **Pipeline component legitimized:** Stage2 mixture posterior (regime weights) within capopm; aggregation of regime_entropy/regime_max_weight into metrics_aggregated.csv.  
  - **Alignment with CAPOPM.pdf:** Theorem 15 addresses mixture posterior concentration but does not quantify entropy/max-weight monotonicity at finite n or specific evidence scaling. The smoke test treats finite small-n sweep as evidence of concentration—implicit, not theorem-backed; in tension with strict asymptotic/mixture theory expectations.

## Criterion-Level Investigation

### regime_entropy_defined — Scenarios B4_regime_concentration__evidence150__seed1 and B4_regime_concentration__evidence50__seed0 (BOTH FAIL)
- **Audit evidence (audit.json):**  
  - metric_path `["aggregated_metrics","capopm","regime_entropy"]`; direction `<=`; threshold `0.0`; metric_values: 0.6931452862410653 (evidence150), 0.6931471263073097 (evidence50); evaluated `true`; pass `false`; reason `null`.  
  - grid_requirement separate (see below). Flags: no status/semantics mismatch; low_n_runs implied by n_runs=5 in summary (metadata not explicit in audit). Calibration/coverage flags not present for this criterion.
- **Backward trace:**  
  1) **audit_contracts.py:** Criterion `regime_entropy_defined` at `src/capopm/experiments/audit_contracts.py:175-188`, expects entropy finite and ≤0 (implying full concentration to a single regime).  
  2) **audit.py:** `_evaluate_criteria` resolves metric from `aggregated_metrics` and compares to threshold with `<=` (`src/capopm/experiments/audit.py:332-418`). No gating except metric presence.  
  3) **runner.py:** `aggregate_metrics` averages per-run `regime_entropy` (NaN-safe mean) (`src/capopm/experiments/runner.py:374-412`). Calibration diagnostics appended later; not used here.  
  4) **b4_regime_posterior_concentration.py:** Per-run `regime_entropy` computed for capopm when mixture_weights exist (`b4_regime_posterior_concentration.py:271-294`); stored in per_run_metrics, then aggregated. Stage2 mixture enabled for capopm; base_out for uncorrected has no regimes. Evidence strength applied prior to run via `apply_evidence_strength(cfg, strength)` (definition not shown—*UNKNOWN exact scaling*). n_runs default 5 in this scenario (`run_b4_scenario` uses cfg n_runs).  
  5) **Upstream modules:** Stage2 mixture weights from `mixture_posterior_params` (`src/capopm/corrections/stage2_structural.py:144-199`) using prior regimes; entropy computed from weight vector; potential degeneracy if weights ~uniform yields entropy ≈ ln(2) ≈ 0.693 (observed). Simulator/likelihood/posterior pipeline standard (`market_simulator.py:73-148`; `likelihood.py:33-43`; `posterior.py:28-135`; Stage1 weights default enabled in base config but capopm uses Stage1+Stage2).  
- **Paper alignment:** Theorem 15 (CAPOPM.pdf text around index ~92214) asserts mixture posterior concentration under sufficient evidence; does not state entropy must be ≤0 (which would mean a single regime). Entropy ~0.693 indicates near-uniform weights over two regimes; the criterion over-asserts convergence to a single component rather than concentration (reduction) relative to prior.  
- **Finite-sample testability:** NO. With n_runs=5 and moderate evidence, entropy staying near ln(2) is expected if data weak; Theorem 15 is asymptotic in evidence. Hard threshold of 0 at finite n is not a valid test; limitation from claim overreach and small synthetic design.  
- **Judgement calls & edge cases:** Regime label degeneracy (symmetry of two regimes) leads to near-uniform weights; prior symmetric regime weights (0.5/0.5) require strong evidence to break symmetry; small n with weak Stage2 offsets; entropy averaged over runs may hide per-run concentration; no CI on entropy; Stage2 may clamp offsets (mixture_posterior_params diagnostics not surfaced).  
- **Fix proposal (documentation only):** Use relative entropy reduction or threshold < ln(2) with CI, or require evidence-strength sweep with trend rather than absolute zero; align criterion to Theorem 15 by testing increased weight on a regime vs prior, not absolute zero. Audit should avoid declaring failure when entropy≈ln(2) at finite n without trend evidence.

### grid_requirement — Scenarios B4_regime_concentration__evidence150__seed1 and B4_regime_concentration__evidence50__seed0 (INDETERMINATE)
- **Audit evidence:** metric_path `null`; comparator_path `null`; direction/threshold `null`; metric_value `null`; evaluated `false`; pass `null`; reason `grid_missing_for_claim` (both scenarios).  
- **Backward trace:**  
  1) **audit_contracts.py:** `_grid_requirement` for B4 at `src/capopm/experiments/audit_contracts.py:189-193` (“Need multiple evidence levels to validate entropy/weight movement.”) sets requires_grid=True.  
  2) **audit.py:** `_evaluate_criteria` sets `grid_points_observed=1` and if < paper_ready_min_grid (2) flags `grid_missing_for_claim` (`audit.py:342-359`; threshold from `paper_config.py:23-24`).  
  3) **runner.py:** Seed/grid coverage counts each summary as single grid point; no cross-scenario aggregation (`audit.py:574-608`).  
  4) **b4_regime_posterior_concentration.py:** Sweep supports multiple evidence_strength values (`run_b4_regime_posterior_concentration`, `b4_regime_posterior_concentration.py:42-63`), but audit per scenario does not see other grid points.  
  5) **Upstream:** Not reached—criterion short-circuited.  
- **Paper alignment:** Theorem 15 concerns concentration as evidence grows; requiring multiple evidence levels is conceptually aligned, but per-scenario grid counting prevents evaluation even when other scenarios exist.  
- **Finite-sample testability:** NO per scenario—grid requirement cannot be satisfied without cross-scenario aggregation. Limitation is audit design (per-scenario counting) and limited sweep (only two evidence levels in smoke and two in claim_table).  
- **Judgement calls & edge cases:** Grid isolation; small n_runs (5) even if grid were aggregated; symmetric regimes cause slow entropy movement.  
- **Fix proposal (documentation only):** Aggregate grid across scenarios before gating; evaluate trend of entropy/max_weight vs evidence_strength with CI; align threshold to concentration trend rather than absolute presence of grid per scenario.

---

AUDIT SUMMARY
- Files inspected: results/paper_artifacts/claim_table.md; results/paper_artifacts/borderline_atlas.md; results/B4_regime_concentration__evidence50__seed0/audit.json; results/B4_regime_concentration__evidence150__seed1/audit.json; results/B4_regime_concentration__evidence50__seed0/summary.json; results/B4_regime_concentration__evidence150__seed1/summary.json; src/capopm/experiments/audit_contracts.py; src/capopm/experiments/audit.py; src/capopm/experiments/runner.py; src/capopm/experiments/b4_regime_posterior_concentration.py; src/capopm/corrections/stage1_behavioral.py; src/capopm/corrections/stage2_structural.py; src/capopm/posterior.py; src/capopm/likelihood.py; src/capopm/market_simulator.py; smoke_test_b4_regime_posterior_concentration.py; docs/CAPOPM_paper.pdf.
- Smoke tests audited: smoke_test_b4_regime_posterior_concentration.py (assumes entropy decreases and max weight increases with evidence_strength at n_runs=3; deterministic outputs).
- Criteria traced: `regime_entropy_defined` (fail in both scenarios); `grid_requirement` (indeterminate in both scenarios).
- Finite-sample untestable claims: Entropy ≤ 0 at finite n with symmetric regimes; grid requirement per scenario without cross-scenario aggregation; Theorem 15 asymptotic concentration not testable with n_runs=5 and two evidence levels.
- Paper–code–audit contradictions: Theorem 15 does not demand entropy=0; audit criterion overstates concentration. Grid gate fails per scenario despite multiple evidence levels existing across runs. Smoke test assumes finite-sample monotonic trend without theorem backing.
- Unresolved ambiguities: Exact effect of `apply_evidence_strength` on counts/prior; whether regime weights should be compared against prior entropy reduction; whether max_weight metric should be audited.  
- What I need next: Clarification on intended concentration metric (entropy vs trend) and evidence-strength application; permission to adjust grid aggregation logic and thresholding in Stage B planning (no changes made now). 
